{% extends "collab/base.html" %}

{% load app_filters %}
{% load static %}
{% load l10n %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="row">
  <div class="fourteen wide column">
    <h1 class="ui header">
      <div class="content">
        {{ feature.title }}
        {% if permissions|lookup:'can_update_feature' %}
          <div class="ui icon right floated compact buttons">
            <a href="{% url 'collab:feature_update' slug=project.slug feature_type_slug=feature.feature_type.slug feature_id=feature.feature_id %}" class="ui button button-hover-orange">
              <i class="inverted grey pencil alternate icon"></i>
            </a>
            <a id="feature-delete" class="ui button button-hover-red">
              <i class="inverted grey trash alternate icon"></i>
            </a>
          </div>
        {% endif %}
        <div class="ui hidden divider"></div>
        <div class="sub header">
          {{ feature.description }}
        </div>
      </div>
    </h1>
  </div>
</div>

<div class="row">
  <div class="seven wide column">
    <table class="ui very basic table">
      <tbody>
        <tr>
          <td>Auteur</td>
          <td>{{ feature.creator.get_full_name|default:feature.creator.username }}</td>
        </tr>
        <tr>
          <td>Date de création</td>
          <td>{{ feature.created_on }}</td>
        </tr>
        <tr>
          <td>Date de derniere modification</td>
          <td>{{ feature.updated_on }}</td>
        </tr>
        <tr>
          <td>Date de d'archivage</td>
          <td>{{ feature.archived_on }}</td>
        </tr>
        <tr>
          <td>Date de suppression</td>
          <td>{{ feature.deletion_on }}</td>
        </tr>
        {% for field in feature_data %}
        <tr>
          <td>{{ field|lookup:'label' }}</td>
          <td>
            {{ field|lookup:'value' }}
          </td>
        </tr>
        {% endfor %}

        <!-- <tr>
          <th>Signalements liés</th>
          {%for row in linked_features %}
          <td>
            {{row.get_relation_type_display}}: <a href="{% url 'collab:feature_detail' slug=project.slug feature_type_slug=feature.feature_type.slug feature_id=row.feature_to  %}" class="header">{{row.feature_to}}</a>
          </td>
          {% empty %}
            <td><i class="minus icon"></td>
          {% endfor %}
        <tr> -->
      </tbody>


    </table>
  </div>
  <div class="seven wide column">
    <a href="{% url 'collab:feature_list' slug=project.slug %}">
      <div id="map"></div>
    </a>
  </div>
</div>

<div class="row">
  <div class="seven wide column">
    <h3 class="ui header">Pièces jointes</h3>
    <div class="ui tiny images">
      <a href="" class="ui medium bordered image">
        <img src="{% static 'collab/img/polygon.png' %}">
      </a>
      <a href="" class="ui medium bordered image">
        <img src="{% static 'collab/img/polygon.png' %}">
      </a>
      <a href="" class="ui medium bordered image">
        <img src="{% static 'collab/img/polygon.png' %}">
      </a>
      <a href="" class="ui medium bordered image">
        <img src="{% static 'collab/img/polygon.png' %}">
      </a>
    </div>
  </div>

  <div class="seven wide column">
    <h3 class="ui header">Activités et commentaires</h3>
    <div class="ui feed">
      <div class="event">
        <div class="content">
          <div class="summary">
              Chouette a mis à jour le signalement
            <div class="date">
              25/06/2020
            </div>
          </div>
        </div>
      </div>
      <div class="ui hidden divider"></div>
      <div class="event">
        <div class="content">
          <div class="summary">
            Machin a ajouté un commentaire
            <div class="date">
              01/01/2000
            </div>
          </div>
          <div class="extra text">
            Hey c'est un commentaire !
          </div>
        </div>
      </div>
    </div>
    <a class="ui compact basic button button-hover-green">
      <i class="ui plus icon"></i>Ajouter un commentaire
    </a>
  </div>
</div>


  <!-- <div class="header">Détail du signalement</div>
    <table class="ui celled table">
      <tbody>
        <tr>
          <th>Identifiant </th>
          <td>{{ feature.feature_id }}</td>
        </tr>
        <tr>
          <th>Date de création</th>
          <td>{{ feature.created_on }}</td>
        </tr>
        <tr>
          <th>Date de derniere modification</th>
          <td>{{ feature.updated_on }}</td>
        </tr>
        <tr>
          <th>Date de d'archivage</th>
          <td>{{ feature.archived_on }}</td>
        </tr>
        <tr>
          <th>Date de suppression</th>
          <td>{{ feature.deletion_on }}</td>
        </tr>
        <tr>
          <th>Auteur</th>
          <td>{{ feature.creator.get_full_name|default:feature.creator.username }}</td>
        </tr>
        {% for field in feature_data %}
        <tr>
          <th>{{ field|lookup:'label' }}</th>
          <td>
            {{ field|lookup:'value' }}
          </td>
        </tr>
        {% endfor %}

        <tr>
          <th>Signalements liés</th>
          {%for row in linked_features %}
          <td>
            {{row.get_relation_type_display}}: <a href="{% url 'collab:feature_detail' slug=project.slug feature_type_slug=feature.feature_type.slug feature_id=row.feature_to  %}" class="header">{{row.feature_to}}</a>
          </td>
          {% empty %}
            <td><i class="minus icon"></td>
          {% endfor %}
        <tr>
      </tbody>


    </table> -->




  <!--  carte -->
  <!-- <div id='mapdetail'></div>

  <div class="ui top attached tabular menu" id="feature_menu">
    <div class="item active" data-tab="comment">Commentaires</div>
  </div> -->

  <!--  comments -->
  <!-- <div class="ui bottom attached tab segment active" id="comments" data-tab="comment">
    {# {% include 'collab/feature/comments.html' %} #}
    {% for comment in comments %}
      {{ comment.comment }}
      {{ comment.author }}
      {{ comment.created_on }}
      {% for attachment in  comment.attachment_set.all %}
        <label>Fichier: </label>
        {{ attachment.title }}
        <a href="{{ attachment.attachment_file.url }}" download>Télécharger</a>
      {% endfor %}
    <br>
    {% endfor %}
    <form id="commentform" action="{% url 'collab:add_comment' slug=project.slug feature_type_slug=feature_type.slug  feature_id=feature.feature_id%}" class="ui form comment_form" method="POST" enctype="multipart/form-data">
      {% for hidden in comment_form.hidden_fields %}
        {{ hidden }}
      {% endfor %}
      {% if comment_form.non_field_errors %}
      <div class="alert alert-danger" role="alert">
        {% for error in comment_form.non_field_errors %}
          {{ error }}
        {% endfor %}
      </div>
      {% endif %}

      {{ comment_form.as_p }}
      <div class="actions">
          <div class="ui cancel button">Annuler</div>
          <button class="ui button green" type="submit">Ajouter</button>
      </div>
    </form>
  </div> -->

<div class="ui mini modal">
  <div class="header">Suppression du signalement</div>
  <div class="content">
    <p>Êtes-vous sûr de vouloir supprimer ce signalement ?</p>
  </div>
  <div class="actions delete_actions">
    <div class="ui negative button">
      Non
    </div>
    <form action="{% url 'collab:feature_delete' slug=project.slug feature_type_slug=feature_type.slug feature_id=feature.feature_id %}" method='POST'>
      {% csrf_token %}
      <input type="hidden" name="_method" value="delete">
      <button type='submit' class="ui positive right labeled icon button">
        Oui
        <i class="checkmark icon"></i>
      </button>
    </form>
  </div>
</div>

<script>

  $('#add_more').click(function() {
    var form_idx = $('#id_form-TOTAL_FORMS').val();
    $('#form_set').append($('#empty_form').html().replace(/__prefix__/g, form_idx));
    $('#id_form-TOTAL_FORMS').val(parseInt(form_idx) + 1);
  });
</script>
{% endblock %}



{% block custom_resources %}
<style>
  #map {
    width: 100%;
    height: 100%;
    min-height: 250px;
  }
</style>

<script type="text/javascript">
  $(document).ready(function() {

    $('#feature-delete').click(function() {
      $('.mini.modal').modal('show')
    })

    var map = L.map('map', {zoomControl: false}).setView([43.604462, 1.444247], 13)
    L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map)

    map.dragging.disable()
    map.doubleClickZoom.disable()
    map.scrollWheelZoom.disable()

    console.log("{{ feature.geom.wkt }}");
    var featureGroup = new L.FeatureGroup()
    var geomFeatureJSON = wellknown.parse("{{ feature.geom.wkt }}")
    console.log('geomFeatureJSON', geomFeatureJSON);
    var geomJSON = turf.flip(geomFeatureJSON)
    console.log('geomJSON', geomJSON);
    if (geomJSON.type === 'Point') {
      L.circleMarker(geomJSON.coordinates, {color: 'green'}).addTo(featureGroup)
    } else if (geomJSON.type === 'LineString') {
      L.polyline(geomJSON.coordinates, {color: 'red'}).addTo(featureGroup)
    } else if (geomJSON.type === 'Polygon') {
      L.polygon(geomJSON.coordinates, {color: 'blue'}).addTo(featureGroup)
    }
    map.addLayer(featureGroup);
    map.fitBounds(featureGroup.getBounds())
  })
</script>
{% endblock %}
