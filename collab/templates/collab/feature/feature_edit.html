{% extends "collab/base.html" %}

{% load app_filters %}
{% load static %}

{% block title %}{{ title }}{% endblock %}


{% block content %}
<div class="fourteen wide column">
  {% if action == 'update' %}
    <h1>Mise à jour du signalement "{{ feature.title }}"</h1>
  {% elif action == 'create' %}
    <h1>Création d'un signalement</h1>
  {% endif %}


  <form id="form-feature-edit" action="" method="post" enctype="multipart/form-data" class="ui form">
    {% csrf_token %}

    <!-- Feature Fields -->
    <div class="two fields">
      <div class="required field">
        <label for="{{ feature_form.title.id_for_label }}">{{ feature_form.title.label }}</label>
        <input type="text" required maxlength="{{ feature_form.title.field.max_length }}"
          name="{{ feature_form.title.html_name }}" id="{{ feature_form.title.id_for_label }}"
          value="{% if feature_form.title.value %}{{ feature_form.title.value }}{% endif %}" >
        {{ feature_form.title.errors }}
      </div>
      <div class="required field">
        <label for="{{ feature_form.status.id_for_label }}">{{ feature_form.status.label }}</label>
        <div class="ui selection dropdown">
          <input type="hidden"
            name="{{ feature_form.status.html_name }}" id="{{ feature_form.status.id_for_label }}"
            value="{% if feature_form.status.value %}{{ feature_form.status.value }}{% endif %}">
          <div class="default text"></div>
          <i class="dropdown icon"></i>
          <div class="menu">
            {% for x,y in feature_form.status.field.choices %}
              <div class="item" data-value="{{ x }}" {% if feature_form.status.value == x %} selected{% endif %}>{{ y }}</div>
            {% endfor %}
          </div>
        </div>
        {{ feature_form.status.errors }}
      </div>
    </div>
    <div class="field">
      <label for="{{ feature_form.description.id_for_label }}">{{ feature_form.description.label }}</label>
      <textarea name="{{ feature_form.description.html_name }}" rows="5">{% if feature_form.description.value %}{{ feature_form.description.value }}{% endif %}</textarea>
      {{ feature_form.description.errors }}
    </div>

    <!-- Geom Field -->
    <div class="field">
      <label for="{{ feature_form.geom.id_for_label }}">{{ feature_form.geom.label }}</label>

      <!-- Import GeoImage -->
      {% if feature_type.geom_type == 'point' %}
      <p>
        <button id="add-geo-image" type="button" class="ui compact basic button">
          <i class="file image icon"></i>Importer une image géoréférencée
        </button>
        Vous pouvez utiliser une image géoréférencée pour localiser le signalement.
      </p>
      {% endif %}

      <!-- Map -->
      <input type="hidden" name="{{ feature_form.geom.html_name }}" id="{{ feature_form.geom.id_for_label }}"
        value="{% if feature_form.geom.value.wkt %}{{ feature_form.geom.value.wkt }}{% endif %}" />
      <div id="map"></div>
    </div>

    <!-- Extra Fields -->
    <div class="ui horizontal divider">DONNÉES MÉTIER</div>
    {% for field in extra_form %}
      <div class="field">
        {% if field.field.widget.attrs|lookup:'field_type' == 'char' %}
          <label for="{{ field.name }}">{{ field.label }}</label>
          <input type="text" name="{{ field.name }}" id="{{ field.name }}"
            value="{% if field.value %}{{ field.value }}{% endif %}" >
        {% elif field.field.widget.attrs|lookup:'field_type' == 'integer' %}
          <label for="{{ field.name }}">{{ field.label }}</label>
          <div class="ui input">
            <input type="number" name="{{ field.name }}" id="{{ field.name }}"
              value="{% if field.value %}{{ field.value }}{% endif %}">
          </div>
        {% elif field.field.widget.attrs|lookup:'field_type' == 'boolean' %}
          <div class="ui checkbox">
            <input type="checkbox" {% if field.value %}checked{% endif %}
              name="{{ field.name }}" id="{{ field.name }}">
            <label for="{{ field.name }}">{{ field.label }}</label>
          </div>
        {% elif field.field.widget.attrs|lookup:'field_type' == 'date' %}
          <label for="{{ field.name }}">{{ field.label }}</label>
          <input type="date" name="{{ field.name }}" id="{{ field.name }}"
            value="{% if field.value %}{{ field.value }}{% endif %}" >
        {% elif field.field.widget.attrs|lookup:'field_type' == 'decimal' %}
          <label for="{{ field.name }}">{{ field.label }}</label>
          <div class="ui input">
            <input type="number" step=".01" name="{{ field.name }}" id="{{ field.name }}"
              value="{% if field.value %}{{ field.value }}{% endif %}">
          </div>
        {% elif field.field.widget.attrs|lookup:'field_type' == 'text' %}
          <label for="{{ field.name }}">{{ field.label }}</label>
          <textarea name="{{ field.name }}" rows="3">{% if field.value %}{{ field.value }}{% endif %}</textarea>
        {% endif %}
        {{ field.errors }}
      </div>
    {% endfor %}

    <!-- Pièces jointes -->
    <div class="ui horizontal divider">PIÈCES JOINTES</div>
    FORMSETS

    <!-- Signalements liés -->
    <div class="ui horizontal divider">SIGNALEMENTS LIÉS</div>
    <table class="ui celled padded table">
      {{ linked_formset.management_form }}
      <div id="form_set">
        {% for formset in linked_formset %}
        {% for hidden in formset.hidden_fields %}
        {{ hidden }}
        {% endfor %}
        {% if formset.non_field_errors %}
        <div class="alert alert-danger" role="alert">
          {% for error in formset.non_field_errors %}
          {{ error }}
          {% endfor %}
        </div>
        {% endif %}
        {% for field in formset.visible_fields %}
        <tr>
          <th>{{ field.label_tag }}</th>
          <td>
            {{ field }}
            {{ field.errors }}
            {{ field.help_text }}
          </td>
        </tr>
        {% endfor %}
        {% endfor %}
      </div>
    </table>
    <input type="button" value="+" id="add_more">
    <div id="empty_form" style="display:none">
      <table class='ui celled padded table'>
        {{ linked_formset.empty_form.as_table }}
      </table>
    </div>
    <table class="ui compact celled definition table">
      <thead>
        <tr>
          <th>Identifiant</th>
          <th>Titre</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
        {% for feat in availables_features %}
        <tr>
          <td>{{ feat.feature_id }}</td>
          <td>{{ feat.title }}</td>
          <td>{{ feat.description }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>


    <div class="ui divider"></div>

    <button type="submit" class="ui basic teal icon button">
      <i class="white save icon"></i> Enregistrer les changements
    </button>

  </form>
</div>

<div class="ui mini modal">
  <div class="content">
    <h3>Importer une image géoréférencée</h3>
    <form class="ui form" enctype="multipart/form-data" method="POST"
      action="{% url 'collab:import_from_image' slug=project.slug feature_type_slug=feature_type.slug %}">
      {% csrf_token %}
      <p>Attention, si vous avez déjà saisi une géométrie, celle issue de l'image importée l'écrasera.</p>

      <div class="field">
        <label>Image (png ou jpeg)</label>
        <label class="ui icon button" for="image_file">
          <i class="file icon"></i>
          <span class="label">Sélectionner une image ...</span>
        </label>
        <input type="file" accept="image/jpeg, image/png" style="display:none;"
          name="image_file" id="image_file" >
        {{ form.errors }}
      </div>

      <button type='submit' class="ui positive right labeled icon button">
        Importer
        <i class="checkmark icon"></i>
      </button>
    </form>
  </div>
</div>

{% endblock %}


{% block custom_resources %}
<style>
#map {
  height:300px;
  width:100%;
}
</style>

<script type="text/javascript">
// Geom types
var geomLeaflet = {
  'point': 'circlemarker',
  'linestring': 'polyline',
  'polygon': 'polygon'
}

function updateGeomField(newGeom) {
  $('#{{ feature_form.geom.id_for_label }}').val(`SRID=4326;${newGeom}`);
}

function truncate(n, len) {
  var ext = n.substring(n.lastIndexOf(".") + 1, n.length).toLowerCase()
  var filename = n.replace('.' + ext, '')
  if (filename.length <= len) {
    return n
  }
  filename = filename.substr(0, len) + (n.length > len ? '[...]' : '')
  return filename + '.' + ext
}

$(document).ready(function() {
  $(document).on('change', '#image_file', function () {
    var logoFile = $(this).prop('files')[0]
    $(this).parent().children('label').children('.label').html(truncate(logoFile.name, 30))
    var reader = new FileReader();
    reader.onload = function(e) {
      $('#form-input-file-logo').attr('src', e.target.result);
    }
    reader.readAsDataURL(this.files[0]);
  })

  $('#add-geo-image').click(function() {
    $('.mini.modal').modal('show')
  })

  var map = L.map('map').setView([43.604462, 1.444247], 13);
  L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
  }).addTo(map)

  // Geom type + init Leaflet Draw Control
  console.log('geomType', "{{ feature_form.geom.value.wkt }}");
  var geomType = "{{ feature_type.geom_type }}"
  var drawConfig = {
    polygon: false,
    marker: false,
    polyline: false,
    rectangle: false,
    circle: false,
    circlemarker: false
  }
  drawConfig[geomLeaflet[geomType]] = true


  var drawnItems = new L.FeatureGroup()
  map.addLayer(drawnItems)
  var geomFeatureJSON = wellknown.parse("{{ feature_form.geom.value.wkt }}")
  if (geomFeatureJSON) {
    var geomJSON = turf.flip(geomFeatureJSON)
    if (geomType === 'point') {
      L.circleMarker(geomJSON.coordinates).addTo(drawnItems)
    } else if (geomType === 'linestring') {
      L.polyline(geomJSON.coordinates).addTo(drawnItems)
    } else if (geomType === 'polygon') {
      L.polygon(geomJSON.coordinates).addTo(drawnItems)
    }
    map.fitBounds(drawnItems.getBounds())
  }

  var drawControlFull = new L.Control.Draw({
    edit: {
      featureGroup: drawnItems
    },
    draw: drawConfig,
  })

  var drawControlEditOnly = new L.Control.Draw({
    edit: {
      featureGroup: drawnItems
    },
    draw: false
  })

  {% if feature_form.geom.value.wkt %}
    map.addControl(drawControlEditOnly);
  {% else %}
    map.addControl(drawControlFull);
  {% endif %}

  map.on("draw:created", function (e) {
    console.log('draw:created')
    var layer = e.layer
    layer.addTo(drawnItems)
    drawControlFull.remove(map)
    drawControlEditOnly.addTo(map)
    updateGeomField(wellknown.stringify(layer.toGeoJSON()))
  })

  map.on("draw:edited", function(e) {
    console.log('draw:edited')
    var layers = e.layers
    layers.eachLayer(function (layer) {
      updateGeomField(wellknown.stringify(layer.toGeoJSON()))
    })
  })

  map.on("draw:deleted", function(e) {
    console.log('draw:deleted')
    drawControlEditOnly.remove(map)
    drawControlFull.addTo(map)
    updateGeomField('')
  })

})
</script>
{% endblock %}
