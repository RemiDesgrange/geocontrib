{% extends "collab/base.html" %}

{% load static %}

{% block title %}Projet {{ project.title }}{% endblock %}

{% block content %}

  {% if permissions|lookup:'can_view_project' %}
  <div class="row">
    <div class="three wide column">
      <img class="ui small image" src="{{ project.thumbnail.url }}">
      <div class="ui basic teal label" data-tooltip="Utilisateurs">
        <i class="user icon"></i>{{ project.nb_contributors }}
      </div>
      <div class="ui basic teal label" data-tooltip="Signalements">
        <i class="map marker icon"></i>{{ features|length }}
      </div>
      <div class="ui basic teal label" data-tooltip="Commentaires">
        <i class="comment icon"></i>{{ comments|length }}
      </div>
    </div>
    <div class="eleven wide column">
      <h1 class="ui header">
        <div class="content">
          {{ project.title }}
          {% if project and permissions|lookup:'can_update_project' %}
            <div class="ui icon right floated compact buttons">
              <a href="{% url 'collab:project_update' slug=project.slug %}" class="ui button button-hover-orange">
                <i class="inverted grey pencil alternate icon"></i>
              </a>
            </div>
          {% endif %}
          <div class="ui hidden divider"></div>
          <div class="sub header">
            {{ project.description }}
          </div>
        </div>
      </h1>
    </div>
  </div>

  <div class="row">
    <div class="seven wide column">
      <h3 class="ui header">Types de signalements</h3>
      <div class="ui middle aligned divided selection list">
        {% for type in feature_types %}
          <div class="item">
            <div class="middle aligned content">
              {% if type.geom_type == 'point' %}
                <img class="list-image-type" src="{% static 'collab/img/marker.png' %}">
              {% elif type.geom_type == 'linestring' %}
                <img class="list-image-type" src="{% static 'collab/img/line.png' %}">
              {% elif type.geom_type == 'polygon' %}
                <img class="list-image-type" src="{% static 'collab/img/polygon.png' %}">
              {% endif %}
              <a href="{% url 'collab:feature_type_detail' slug=project.slug feature_type_slug=type.slug %}">{{ type.title }}</a>
              {% if project and feature_types and permissions|lookup:'can_create_feature' %}
              <a class="ui compact small icon right floated button" data-tooltip="Ajouter un signalement" data-position="left center" data-variation="mini"
                 href="{% url 'collab:feature_create' slug=project.slug feature_type_slug=type.slug %}">
                <i class="ui plus icon"></i>
              </a>
              {% endif %}
            </div>
          </div>
        {% empty %}
          <div>
            <i>
              Le projet ne contient pas encore de signalement.
            </i>
          </div>
        {% endfor %}
      </div>
      <a class="ui compact basic button button-hover-green" href="{% url 'collab:feature_type_create' slug=project.slug %}">
        <i class="ui plus icon"></i>Créer un nouveau type de signalement
      </a>
    </div>
    <div class="seven wide column">
      <a href="{% url 'collab:feature_list' slug=project.slug %}">
        <div id="map"></div>
      </a>
    </div>
  </div>

  <div class="row">
    <div class="fourteen wide column">
      <div class="ui two stackable cards">
        <div class="red card">
          <div class="content">
            <div class="center aligned header">Derniers signalements</div>
            <div class="center aligned description">
              {% for item in last_features %}
                <p>{{ item.title }}</p>
              {% empty %}
                <i>Aucun signalement pour le moment.</i>
              {% endfor %}
            </div>
          </div>
        </div>
        <div class="orange card">
          <div class="content">
            <div class="center aligned header">Derniers commentaires</div>
            <div class="center aligned description">
              <div class="ui relaxed list">
                {% for elt in comments %}
                  <div class="item">
                    <div class="content">
                      <div>"{{ elt.comment }}"</div>
                      <div class="description">
                        <i>Par {{ elt.author__first_name|title }} {{ elt.author__last_name }}, le {{ elt.creation_date|date:"d M Y" }}</i>
                      </div>
                    </div>
                  </div>
                {% empty %}
                  <i>Aucun commentaire pour le moment.</i>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="fourteen wide column" >
      <div class="ui grey segment" style="background:#e8e8e8">
        <h3 class="ui header">Paramètres du projet</h3>
        <div class="ui five stackable cards">
          <div class="card">
            <div class="center aligned content">
              <h4 class="ui center aligned icon header">
                <i class="archive icon"></i>
                <div class="content">Délai avant archivage automatique</div>
              </h4>
            </div>
            <div class="center aligned extra content">{{ project.archive_feature }} jours</div>
          </div>
          <div class="card">
            <div class="content">
              <h4 class="ui center aligned icon header">
                <i class="trash alternate icon"></i>
                <div class="content">Délai avant suppression automatique</div>
              </h4>
            </div>
            <div class="center aligned extra content">{{ project.delete_feature }} jours</div>
          </div>
          <div class="card">
            <div class="content">
              <h4 class="ui center aligned icon header">
                <i class="eye icon"></i>
                <div class="content">Visibilité des signalements publiés</div>
              </h4>
            </div>
            <div class="center aligned extra content">{{ project.access_level_pub_feature.get_user_type_id_display }}</div>
          </div>
          <div class="card">
            <div class="content">
              <h4 class="ui center aligned icon header">
                <i class="eye icon"></i>
                <div class="content">Visibilité des signalements archivés</div>
              </h4>
            </div>
            <div class="center aligned extra content">{{ project.access_level_arch_feature.get_user_type_id_display }}</div>
          </div>
          <div class="card">
            <div class="content">
              <h4 class="ui center aligned icon header">
                <i class="cogs icon"></i>
                <div class="content">Modération</div>
              </h4>
            </div>
            <div class="center aligned extra content">{% if project.moderation %}Oui{% else %}Non{% endif %}</div>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% else %}
  <i class='icon exclamation triangle'></i>
  <span>Vous ne disposez pas des droits nécessaires.</span>
  {% endif %}

{% endblock %}

{% block custom_resources %}
<style>
  #map {
    width: 100%;
    height: 100%;
    min-height: 250px;
  }
  .list-image-type {
    height: 15px;
    vertical-align: bottom;
  }
</style>

<script type="text/javascript">
  $(document).ready(function() {
    var map = L.map('map', {zoomControl: false}).setView([43.604462, 1.444247], 13)
    L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map)

    map.dragging.disable()
    map.doubleClickZoom.disable()
    map.scrollWheelZoom.disable()
  })
</script>
{% endblock %}
